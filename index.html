<!DOCTYPE html>
<!--
Bước 0 — TỔNG QUAN
• Ứng dụng web 1 trang (SPA nhỏ) để dự đoán “cụm khách hàng”.
• Có 3 cách nhập dữ liệu: (1) gõ từng khách hàng, (2) dán nhiều dòng, (3) tải file CSV/XLSX.
• Gọi 1 API dự đoán duy nhất; tự động dò định dạng payload phù hợp; ánh xạ nhãn trả về sang tên cụm + gợi ý hành động.
• Cho phép xem trước, hiển thị bảng kết quả, tiến độ, và tải CSV kết quả.
-->
<html lang="vi">
<head>
  <!-- Bước 1 — Thiết lập cơ bản cho trang -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><strong>HỆ THỐNG DỰ ĐOÁN CỤM KHÁCH HÀNG</strong></title>

  <!-- Bước 2 — Thư viện đọc CSV/XLSX trên trình duyệt -->
  <!-- PapaParse: phân tích CSV; SheetJS: đọc Excel (.xlsx/.xls) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    /* Bước 3 — Phong cách giao diện (CSS) */
    :root{
      --bg:#FFFFFF; --surface:#F5F7FB; --surface-2:#EAF2FF;
      --text:#222; --muted:#6A7480; --border:#E3E8EF;
      --blue:#1E88E5; --orange:#FF8A00; --orange-2:#D86F00;
      --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
      --shadow:0 10px 30px rgba(24,39,75,.06); --br:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:"Myriad Pro","Segoe UI",Inter,system-ui,-apple-system,Roboto,Arial,sans-serif;
      font-weight:350;letter-spacing:.1px;
    }

    .container{max-width:1200px;margin:32px auto;padding:0 20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{
      display:flex;align-items:center;gap:16px;
      padding:14px 24px;border-radius:30px;
      background:linear-gradient(135deg,rgba(208,226,255,.65),rgba(237,243,255,.9));
      box-shadow:0 10px 30px rgba(30,136,229,.12);
      border:1px solid rgba(143,180,247,.35);
    }
    .logo{
      width:44px;height:44px;border-radius:12px;background:#fff;border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;overflow:hidden;
      box-shadow:0 8px 24px rgba(30,136,229,.25);
    }
    .logo img{width:100%;height:100%;object-fit:contain;display:block}
    h1{margin:0;font-weight:300}
    h1.brand-title{text-transform:uppercase;font-weight:700;}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:18px 0}
    .tab-btn{
      padding:10px 14px;border-radius:999px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:500;color:#22324D;transition:all .2s ease;
    }
    .tab-btn:hover{border-color:#d1d8e2}
    .tab-btn.active{
      border-color:transparent;
      background:linear-gradient(180deg,var(--orange),var(--orange-2));
      color:#fff;box-shadow:0 6px 18px rgba(255,138,0,.35);
    }

    .panel{background:#fff;border:1px solid var(--border);border-radius:var(--br);box-shadow:var(--shadow);padding:20px;margin-bottom:20px}
    .panel.soft{background:var(--surface)} .panel.accent{background:var(--surface-2)}

    .grid{display:grid;gap:14px}
    @media(min-width:920px){ .grid.cols-2{grid-template-columns:1fr 1fr} }

    label{display:block;margin-bottom:6px;color:#273142;font-weight:400}
    input, textarea, select{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);
      background:#fff;color:var(--text);outline:none;font-weight:350;
    }
    textarea{min-height:140px;resize:vertical;font-family:ui-monospace,Menlo,monospace;font-size:13px}

    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .btn{
      display:inline-flex;align-items:center;gap:8px;
      background:linear-gradient(180deg,var(--blue),#1669c2);
      color:white;border:0;border-radius:12px;padding:12px 16px;cursor:pointer;
      font-weight:600; box-shadow:0 8px 22px rgba(30,136,229,.35);
    }
    .btn.secondary{
      background:linear-gradient(180deg,var(--orange),var(--orange-2));
      box-shadow:0 8px 22px rgba(255,138,0,.35);
    }
    .btn.ghost{background:#fff;color:#22324D;border:1px solid var(--border);box-shadow:none}
    .btn.full{width:100%}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .status{margin-top:14px;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .status.ok{border-color:#b9f5cc;background:#f3fff6;color:#0f6b2f}
    .status.err{border-color:#ffd1d1;background:#fff5f5;color:#9c1c1c}
    .status.warn{border-color:#ffe0b2;background:#fff8e6;color:#8b4d00}

    .progress{width:100%;height:10px;border-radius:999px;background:#eff2f7;border:1px solid var(--border);overflow:hidden}
    .progress > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--orange),var(--blue));transition:width .2s ease}

    table{width:100%;border-collapse:collapse;margin-top:14px;background:#fff;border-radius:12px;overflow:hidden}
    thead{background:#f7f9fc}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{font-weight:600;color:#22324D}

    .drop{border:2px dashed #cfd6e4;border-radius:16px;background:#fff;padding:28px;text-align:center;color:#415164}
    .drop.drag{border-color:var(--blue);background:linear-gradient(180deg,#fff,#f3f8ff)}

    .spinner{display:none;margin-left:8px;border:3px solid #dbe3ef;border-top:3px solid #fff;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite}
    .spinner.show{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
    code.inline{background:#f2f4f8;border:1px solid var(--border);border-radius:6px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="container">
    <!-- Bước 4 — Header & logo -->
    <header>
      <div class="brand">
        <div class="logo">
          <img id="appLogo"
               src="https://lh3.googleusercontent.com/d/1NPBpI4aCFh6TV2IG9asVzKRbDfpkRpBb"
               alt="Logo" loading="lazy" referrerpolicy="no-referrer" />
        </div>
        <div>
          <h1 class="brand-title">M&#193;Y D&#7920; &#272;O&#193;N C&#7908;M KH&#193;CH H&#192;NG</h1>
        </div>
      </div>
    </header>

    <div class="header-banner" aria-hidden="true"></div>

    <!-- Bước 5 — Tabs điều hướng 3 cách nhập liệu -->
    <div class="tabs">
     <button class="tab-btn active" data-tab="single"><strong>1) Dự đoán từng khách hàng</strong></button>
     <button class="tab-btn" data-tab="paste"><strong>2) Dự đoán nhiều khách hàng </strong></button>
     <button class="tab-btn" data-tab="upload"><strong>3) Dự đoán bằng file CSV/XLSX</strong></button>
    </div>

    <!-- Bước 6 — Tab 1: Form dự đoán cho 1 khách hàng -->
    <section class="panel" id="tab-single">
      <div class="grid cols-2">
        <div>
          <label for="age">Tuổi (<code class="inline">age</code>)</label>
          <input id="age" type="number" step="1" value="38" />
          <div class="hint">VD: 38</div>
        </div>
        <div>
          <label for="total_debt">Tổng nợ (<code class="inline">total_debt</code>)</label>
          <input id="total_debt" type="number" step="any" value="40000" />
          <div class="hint">VD: 40000</div>
        </div>
        <div>
          <label for="avg_amount">Tổng tiền GD TB (<code class="inline">avg_amount</code>)</label>
          <input id="avg_amount" type="number" step="any" value="20" />
          <div class="hint">VD: 20</div>
        </div>
        <div>
          <label for="credit_score">Điểm tín dụng (<code class="inline">credit_score</code>)</label>
          <input id="credit_score" type="number" step="1" value="720" />
          <div class="hint">VD: 720</div>
        </div>
      </div>

      <div class="row" style="margin-top:16px">
        <button id="btnSingle" class="btn">Dự đoán <span id="spinSingle" class="spinner"></span></button>
      </div>

      <div id="singleStatus" class="status" style="display:none"></div>
    </section>

    <!-- Bước 7 — Tab 2: Dán nhiều dòng và dự đoán hàng loạt -->
    <section class="panel soft" id="tab-paste" style="display:none">
      <div class="hint"><strong>Thứ tự cột:</strong> age, total_debt, avg_amount, credit_score</div>
      <label for="bulkInput" style="margin-top:10px">Dán dữ liệu (mỗi dòng 4 số, phẩy hoặc tab):</label>
      <textarea id="bulkInput" placeholder="38,40000,20,720
41,25000,15,690"></textarea>
      <div class="row" style="margin-top:12px">
        <button id="btnBatch" class="btn">Dự đoán nhiều khách hàng <span id="spinBatch" class="spinner"></span></button>
        <button id="btnDownloadPaste" class="btn secondary" disabled>Tải kết quả (CSV)</button>
      </div>
      <div id="batchErrors" class="status warn" style="display:none"></div>
      <div id="batchStatus" class="status" style="display:none"></div>
      <div id="tableWrapPaste"></div>
    </section>

    <!-- Bước 8 — Tab 3: Tải và xử lý file CSV/XLSX -->
    <section class="panel accent" id="tab-upload" style="display:none">
      <div class="grid cols-2">
        <div>
          <div id="drop" class="drop">
            <strong>Kéo & thả</strong> file CSV/XLSX vào đây<br/>hoặc <br/>
            <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" />
            <div class="hint">Tên cột gợi ý: <code class="inline">total_debt</code>, <code class="inline">avg_amount</code>, <code class="inline">credit_score</code>, <code class="inline">age</code></div>
          </div>
        </div>
        <div class="panel" style="margin:0">
          <div style="font-weight:600;margin-bottom:8px">Xác nhận cột</div>
          <div class="grid">
            <div><label>total_debt</label><select id="map_debt"></select></div>
            <div><label>avg_amount</label><select id="map_avg"></select></div>
            <div><label>credit_score</label><select id="map_score"></select></div>
            <div><label>age</label><select id="map_age"></select></div>
          </div>
          <div class="hint">Tự nhận theo header. Có thể thay đổi nếu hệ thống xác định sai.</div>
        </div>
      </div>

      <div id="fileInfo" class="status" style="display:none;margin-top:14px"></div>

      <div id="previewWrap" style="display:none">
        <div style="font-weight:600;margin:16px 0 6px">Xem trước (10 dòng đầu):</div>
        <div id="previewTable"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="btnPredictFile" class="btn" disabled>Bắt đầu dự đoán <span id="spinFile" class="spinner"></span></button>
        <button id="btnDownloadFile" class="btn secondary" disabled>Tải kết quả (CSV)</button>
      </div>

      <div id="fileProgress" style="display:none;margin-top:12px">
        <div class="progress"><span id="progressBar"></span></div>
        <div id="progressText" class="hint" style="margin-top:6px">0%</div>
      </div>

      <div id="fileStatus" class="status" style="display:none"></div>
      <div id="tableWrapFile"></div>
    </section>
  </div>

  <script>
    // Bước 9 — Logo fallback (đổi nguồn ảnh nếu link đầu lỗi)
    (function ensureLogo(){
      const id = "1NPBpI4aCFh6TV2IG9asVzKRbDfpkRpBb";
      const primary = `https://lh3.googleusercontent.com/d/${id}`;
      const fallback = `https://drive.google.com/uc?export=view&id=${id}`;
      const img = document.getElementById("appLogo");
      if (!img) return;
      let triedFallback = false;
      img.addEventListener("error", () => {
        if (!triedFallback) { triedFallback = true; img.src = fallback; }
        else img.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2P4//8/AwAI/AL+1A9qJQAAAABJRU5ErkJggg==";
      });
      if (!img.src.includes("googleusercontent.com")) img.src = primary;
    })();

    // ================== CONFIG ==================
    // Bước 10 — Khai báo URL API AWS dùng để dự đoán
    const API_URL = "https://jbgd438w8d.execute-api.ap-southeast-2.amazonaws.com/prod/predict";

    // ================== UTIL ==================
    // Bước 11 — Các tiện ích dùng chung (DOM helper, hiển thị trạng thái, parse số, CSV,...)
    const $ = (id)=>document.getElementById(id);
    const show = (el,on=true)=>{ el.style.display = on ? "" : "none"; };
    const setStatus = (el,msg,type)=>{ el.className="status "+(type||""); el.innerHTML=msg; show(el,true); };
    const toNumber = (x)=>{ const n=Number(x); return Number.isFinite(n)?n:NaN; };
    const truncate = (s,max=800)=> (s && s.length>max) ? s.slice(0,max)+" …(cắt)" : (s ?? "");
    const safeParseJSON = (txt)=>{ try{return JSON.parse(txt);}catch{ return { _raw: txt }; } };
    const withBOM = (csv)=> '\uFEFF' + csv;
    const buildApiList = (age,total_debt,avg_amount,credit_score)=>[ total_debt, avg_amount, credit_score, age ];
    const csvEscape = (v)=> `"${String(v??"").replace(/"/g,'""')}"`;

    // Bước 12 — Tên cụm & gợi ý hành động
    const CLUSTER_MAP = {
      "0_Young":        { name:"Trẻ – chi tiêu thấp – nợ trung bình",           hint:"Giới thiệu sản phẩm tín dụng nhỏ, khuyến mãi học tập hoặc tiêu dùng" },
      "0_Middle-aged":  { name:"Trung niên – chi tiêu thấp – nợ trung bình",      hint:"Cung cấp các gói tín dụng cá nhân linh hoạt" },
      "0_Senior":       { name:"Cao tuổi – chi tiêu trung bình – nợ thấp",     hint:"Giới thiệu sản phẩm tiết kiệm và bảo hiểm sức khỏe" },
      "1_Young":        { name:"Trẻ – chi tiêu cao – nợ trung bình",             hint:"Phát hành thẻ tín dụng cao cấp, ưu đãi du lịch" },
      "1_Middle-aged":  { name:"Trung niên – chi tiêu cao – nợ trung bình",       hint:"Phát hành thẻ tín dụng cao cấp, tiết kiệm song song" },
      "1_Senior":       { name:"Cao tuổi – chi tiêu cao – nợ thấp",              hint:"Khuyến khích đầu tư an toàn, gói hưu trí" },
      "2_Young":        { name:"Trẻ – chi tiêu TB – nợ cao – tín dụng tốt",       hint:"Đề xuất gói vay kinh doanh, quản lý tài chính" },
      "2_Middle-aged":  { name:"Trung niên – chi tiêu TB – nợ cao – tín dụng tốt",  hint:"Gợi ý tái cấp vốn, tiết kiệm lãi suất" },
      "2_Senior":       { name:"Cao tuổi – chi tiêu TB – nợ rất cao",         hint:"Tư vấn bảo hiểm & quản lý danh mục đầu tư" },
      "3_Young":        { name:"Trẻ – chi tiêu TB – nợ TB – tín dụng rất tốt",    hint:"Đề xuất làm đại sứ thương hiệu, ưu đãi đặc biệt" },
      "3_Middle-aged":  { name:"Trung niên – chi tiêu TB – nợ TB – tín dụng cao nhất", hint:"Triển khai dịch vụ VIP, cá nhân hóa" },
      "3_Senior":       { name:"Cao tuổi – chi tiêu TB – nợ thấp – tín dụng rất tốt", hint:"Gợi ý đầu tư an toàn, tiết kiệm cao cấp" },
      "4_Young":        { name:"Trẻ – chi tiêu TB – nợ cao – tín dụng thấp",      hint:"Giảm hạn mức, giám sát gắt gao" },
      "4_Middle-aged":  { name:"Trung niên – chi tiêu TB – nợ cao – tín dụng thấp", hint:"Tăng kiểm tra tín dụng, khuyến khích trả dần" },
      "4_Senior":       { name:"Cao tuổi – chi tiêu TB – nợ TB – tín dụng yếu",   hint:"Theo dõi sát lịch trả nợ, hỗ trợ tư vấn tài chính" }
}
```
    };

    // Bước 13 — Hàm chuẩn hoá & bắt key cụm từ chuỗi trả về của API
    const _norm = (s)=> (s||"").toString().toLowerCase().replace(/\s+/g,"").replace(/-/g,"_");
    function normalizeClusterKey(raw){
      if (!raw) return null;
      const s = _norm(raw);
      // Dạng "2_young", "3_middleaged", ...
      let m = s.match(/(\d)[_\s]*?(young|middle[_]?aged|senior)/);
      if (!m){
        // Dạng "young_2" => đảo vị trí để tạo key chuẩn
        m = s.match(/(young|middle[_]?aged|senior)[_\s]*?(\d)/);
        if (m) m = [m[0], m[2], m[1]]; // [all, num, group]
      }
      if (!m) return null;
      const num = m[1];
      const grp = m[2].includes("middle") ? "middle_aged" : (m[2]==="young"?"young":"senior");
      return `${num}_${grp}`;
    }

    // Bước 14 — Tách thông tin kết quả từ mọi format JSON có thể
// Tóm tắt: Đỡ mọi kiểu phản hồi (có/không có body) → lấy label/text + code để dùng tiếp.
    function extractOutcome(d){
      try{
        let x=d;
        if (x && typeof x.body==="string"){ try{x=JSON.parse(x.body);}catch{} }
        if (x && x.body && typeof x.body==="object"){ x=x.body; }
        let label = x?.prediction ?? x?.cluster ?? x?.subcluster ?? x?.label ?? x?.segment ?? x?.group ?? x?.class ?? x?.class_name;
        const code  = x?.prediction_encoded ?? x?.code ?? x?.cluster_id ?? x?.subcluster_id;
        let text = x?.message ?? x?.result ?? x?.output ?? label;
        if (!text && label) text = String(label);
        if (text && code!==undefined && !String(text).includes(code)) text += ` (mã ${code})`;
        return { ok:true, text, label, code, raw:x };
      }catch{}
      return { ok:false };
    }

    // Bước 15 — Suy ra tên cụm & gợi ý từ bảng ánh xạ; nếu không khớp thì fallback chung
// Tóm tắt: Có key hợp lệ → lấy tên cụm + hint; không có → mô tả chung để vẫn hiển thị.
    function deriveByMap(labelOrText){
      const key = normalizeClusterKey(labelOrText);
      if (key && CLUSTER_MAP[key]) return { key, ...CLUSTER_MAP[key] };
      return null;
    }
    function fallbackDescribe({label,text,code}){
      const value = label ?? text ?? "";
      return {
        key:null,
        name: value ? `Cụm ${value}` : (code!==undefined?`Cụm #${code}`:"Cụm chưa xác định"),
        hint:"Theo dõi thêm hành vi; thử A/B giữ chân và upsell."
      };
    }

    // Bước 16 — Gọi API thông minh: thử lần lượt 3 kiểu payload => chọn kiểu phù hợp
// Tóm tắt: Chuẩn bị 3 payload → fetch API → extractOutcome → map (CLUSTER_MAP) → trả kết quả gọn.
    let detectedPayloadIndex = 0; // Nhớ kiểu payload đã hoạt động để dùng cho lần sau
    async function callPredictionAPISmart(obj,list,debugHook){
      // 16.1 Chuẩn bị 3 biến thể payload: [data:[]], [data:{}], {...}
      const payloads = [
        {desc:'{"data":[...]}', body:{ data: list }},
        {desc:'{"data":{...}}', body:{ data: obj }},
        {desc:'{...}',          body: obj}
      ];
      // 16.2 Quyết định thứ tự thử; ưu tiên kiểu đã thành công gần nhất
      const order = detectedPayloadIndex!=null ? [detectedPayloadIndex, ...[0,1,2].filter(i=>i!==detectedPayloadIndex)] : [0,1,2];

      for(const i of order){
        const p = payloads[i];
        try{
          // 16.3 Gọi API
          const res = await fetch(API_URL, {
            method:"POST",
            headers:{ "Content-Type":"application/json", "Accept":"application/json" },
            body: JSON.stringify(p.body)
          });
          // 16.4 Đọc & parse an toàn, rồi trích kết quả
          const ct = res.headers.get("content-type") || "";
          const rawText = await res.text();
          const parsed = ct.includes("application/json") ? safeParseJSON(rawText) : safeParseJSON(rawText);
          const out = extractOutcome(parsed);
          debugHook?.({tried:p.desc,status:res.status,ok:res.ok,contentType:ct,raw:truncate(rawText)});
          // 16.5 Nếu ok, ánh xạ tên cụm + gợi ý và trả về
          if (res.ok && out.ok){
            detectedPayloadIndex = i;
            const mapHit = deriveByMap(out.label || out.text);
            const mapped = mapHit ?? fallbackDescribe(out);
            return {
              ok:true,
              msg: out.text ?? (out.label ?? "Đã dự đoán"),
              label: out.label,
              code: out.code,
              name: mapped.name,
              hint: mapped.hint,
              key: mapped.key
            };
          }
        }catch(err){
          const e = String(err);
          debugHook?.({tried:p.desc,status:'ERR',ok:false,contentType:'',raw:e});
          if (e.includes("Failed to fetch")) return { ok:false, msg:"Không gọi được API (khả năng CORS)." };
        }
      }
      // 16.6 Không định dạng nào nhận diện được
      return { ok:false, msg:"API không trả kết quả nhận diện được." };
    }

    // Bước 17 — Xử lý chuyển tab (ẩn/hiện panel)
    document.querySelectorAll(".tab-btn").forEach(b=>{
      b.addEventListener("click",()=>{
        document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        show($("tab-single"), b.dataset.tab==="single");
        show($("tab-paste"),  b.dataset.tab==="paste");
        show($("tab-upload"), b.dataset.tab==="upload");
      });
    });

    // Bước 18 — Luồng “Dự đoán từng khách hàng”
// Tóm tắt: Nhập 4 số → kiểm tra → gọi API → hiển thị tên cụm + gợi ý ngay dưới nút.
    $("btnSingle").addEventListener("click", async ()=>{
      // 18.1 Lấy & kiểm tra 4 giá trị số
      const age          = toNumber($("age").value);
      const total_debt   = toNumber($("total_debt").value);
      const avg_amount   = toNumber($("avg_amount").value);
      const credit_score = toNumber($("credit_score").value);
      if([age,total_debt,avg_amount,credit_score].some(v=>Number.isNaN(v))){
        setStatus($("singleStatus"), "Sai định dạng. Cần 4 số.", "err"); return;
      }
      // 18.2 Hiển thị trạng thái & chuẩn bị payload 2 kiểu
      $("spinSingle").classList.add("show");
      setStatus($("singleStatus"), "Đang gọi API...", "warn");
      const payloadObj = { age, total_debt, avg_amount, credit_score };
      const payloadList = buildApiList(age, total_debt, avg_amount, credit_score);
      // 18.3 Gọi API thông minh
      const r = await callPredictionAPISmart(payloadObj, payloadList);
      // 18.4 Hiển thị kết quả
      $("spinSingle").classList.remove("show");
      setStatus(
        $("singleStatus"),
        r.ok
          ? `✅ ${r.msg}<br><b>Tên cụm mô tả:</b> ${r.name}<br><b>Gợi ý hành động:</b> ${r.hint}`
          : `❌ ${r.msg}`,
        r.ok ? "ok" : "err"
      );
    });

    // Bước 19 — Luồng “Dán dữ liệu nhiều dòng”
// Tóm tắt: Dán nhiều dòng → parse/validate → gọi API từng dòng → render bảng + cho tải CSV.
    let pasteCSV = ""; // buffer tạo file CSV kết quả để tải xuống
    $("btnBatch").addEventListener("click", async ()=>{
      // 19.1 Tách các dòng, kiểm tra định dạng
      const raw = $("bulkInput").value.trim();
      $("tableWrapPaste").innerHTML=""; show($("batchErrors"),false); show($("batchStatus"),false);
      $("btnDownloadPaste").disabled=true; pasteCSV="";
      if(!raw){ setStatus($("batchStatus"), "Vui lòng nhập dữ liệu.", "warn"); return; }

      const lines = raw.split(/\r?\n/); const parsed=[]; const errors=[];
      for(let i=0;i<lines.length;i++){
        const line=lines[i].trim(); if(!line) continue;
        const delimiter = line.includes(",") ? "," : "\t";
        const parts = line.split(delimiter).map(s=>s.trim());
        if(parts.length!==4){ errors.push(`Dòng ${i+1}: cần 4 cột, nhận ${parts.length}.`); continue; }
        const nums = parts.map(toNumber);
        if(nums.some(v=>Number.isNaN(v))){ errors.push(`Dòng ${i+1}: có giá trị không phải số.`); continue; }
        parsed.push(nums);
      }
      if(errors.length) setStatus($("batchErrors"), `<b>Lỗi định dạng:</b><br>${errors.map(e=>"- "+e).join("<br>")}`, "warn");
      if(!parsed.length){ setStatus($("batchStatus"), "Không có dòng hợp lệ.", "warn"); return; }

      // 19.2 Gọi API theo từng dòng, gom kết quả
      $("spinBatch").classList.add("show");
      setStatus($("batchStatus"), `Đang dự đoán cho ${parsed.length} khách hàng...`, "warn");
      const results=[];
      for(let i=0;i<parsed.length;i++){
        const [ageVal,debt,avg,score] = parsed[i];
        const payloadObj = { age: ageVal, total_debt: debt, avg_amount: avg, credit_score: score };
        const payloadList = buildApiList(ageVal, debt, avg, score);
        const r = await callPredictionAPISmart(payloadObj, payloadList);
        results.push(r.ok?{msg:r.msg,name:r.name,hint:r.hint}:{msg:`Lỗi: ${r.msg}`,name:"",hint:""});
      }
      $("spinBatch").classList.remove("show");
      setStatus($("batchStatus"), `✅ Xong ${parsed.length} dòng.`, "ok");

      // 19.3 Render bảng kết quả & chuẩn bị CSV để tải
      const tbl=document.createElement("table");
      tbl.innerHTML=`<thead><tr>
        <th>#</th><th>age</th><th>total_debt</th><th>avg_amount</th><th>credit_score</th>
        <th>Kết quả</th><th>Tên cụm mô tả</th><th>Gợi ý hành động</th>
      </tr></thead><tbody></tbody>`;
      const tbody=tbl.querySelector("tbody");
      parsed.forEach((r,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td>
                      <td>${results[i].msg}</td><td>${results[i].name}</td><td>${results[i].hint}</td>`;
        tbody.appendChild(tr);
      });
      $("tableWrapPaste").appendChild(tbl);

      const header=["age","total_debt","avg_amount","credit_score","prediction","cluster_name","action_hint"];
      pasteCSV = [header.join(",")].concat(parsed.map((r,i)=>[
        r[0],r[1],r[2],r[3],results[i].msg,results[i].name,results[i].hint
      ].map(csvEscape).join(","))).join("\n");
      $("btnDownloadPaste").disabled=false;
    });

    // 19.4 Tải xuống CSV kết quả cho luồng "dán"
    $("btnDownloadPaste").addEventListener("click", ()=>{
      if(!pasteCSV) return;
      const blob = new Blob([withBOM(pasteCSV)], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="ket_qua_du_doan.csv";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Bước 20 — Luồng “Tải file CSV/XLSX”
// Tóm tắt: Kéo‑thả/chọn file → tự nhận cột (cho chỉnh) → xem trước 10 dòng → sẵn sàng dự đoán hàng loạt.
    const drop = $("drop");
    // 20.1 Kéo-thả: hiệu ứng & nhận file
    ;["dragenter","dragover"].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();e.stopPropagation();drop.classList.add("drag");}));
    ;["dragleave","drop"].forEach(ev=>drop.addEventListener(ev,(e)=>{e.preventDefault();e.stopPropagation();drop.classList.remove("drag");}));
    drop.addEventListener("drop",(e)=>{ const f=e.dataTransfer.files?.[0]; if(f) handleFile(f); });
    // 20.2 Chọn file qua input
    $("fileInput").addEventListener("change", (e)=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });

    let fileRows = [], fileCols = [];
    let mapped = { age:0, debt:1, avg:2, score:3 };

    // 20.3 Logic xác định & ánh xạ cột
    function normalizeName(s){ return (s||"").toString().toLowerCase().replace(/[^a-z0-9]+/g,""); }
    function autoMapColumns(names){
      const keyMap = {
        debt: ["totaldebt","debt","tongno","no"],
        avg: ["avgamount","averageamount","avg","tongtientb","tb","average"],
        score: ["creditscore","score","diemtindung"],
        age: ["age","tuoi"]
      };
      const idxOf = (cands)=>{ for(let i=0;i<names.length;i++){ const n=normalizeName(names[i]); if(cands.some(k=>n.includes(k))) return i; } return -1; };
      const d = idxOf(keyMap.debt), a = idxOf(keyMap.avg), s = idxOf(keyMap.score), g = idxOf(keyMap.age);
      return { age: g>=0?g:0, debt: d>=0?d:1, avg: a>=0?a:2, score: s>=0?s:3 };
    }
    function populateMappingSelects(names){
      const setOpts = (sel, idx)=>{ sel.innerHTML = names.map((n,i)=>`<option value="${i}" ${i===idx?"selected":""}>${n}</option>`).join(""); };
      setOpts($("map_debt"), mapped.debt); setOpts($("map_avg"), mapped.avg);
      setOpts($("map_score"),mapped.score); setOpts($("map_age"), mapped.age);
      $("map_debt").onchange=e=>mapped.debt=Number(e.target.value);
      $("map_avg").onchange =e=>mapped.avg =Number(e.target.value);
      $("map_score").onchange=e=>mapped.score=Number(e.target.value);
      $("map_age").onchange =e=>mapped.age=Number(e.target.value);
    }
    function renderPreview(rows, names){
      const head = `<thead><tr>${names.map(n=>`<th>${n}</th>`).join("")}</tr></thead>`;
      const body = rows.slice(0,10).map(r=>`<tr>${r.map(c=>`<td>${c ?? ""}</td>`).join("")}</tr>`).join("");
      $("previewTable").innerHTML = `<table>${head}<tbody>${body}</tbody></table>`;
      show($("previewWrap"), true);
    }

    // 20.4 Đọc file (CSV hoặc XLSX) và chuẩn hoá dữ liệu
    async function handleFile(file){
      fileRows = []; fileCols = [];
      $("tableWrapFile").innerHTML = "";
      $("btnPredictFile").disabled = true;
      $("btnDownloadFile").disabled = true;
      show($("fileProgress"), false);
      setStatus($("fileInfo"), `Đang đọc file: <b>${file.name}</b> (${Math.round(file.size/1024)} KB)`, "warn");

      const ext = file.name.toLowerCase().split('.').pop();
      try{
        if (ext === "csv"){ await parseCSV(file); } else { await parseXLSX(file); }
        // 20.4.1 Nhận diện header: nếu dòng đầu chứa chữ -> coi là tên cột
        let headerRow = fileRows[0] || [];
        const looksLikeHeader = headerRow.some(v => isNaN(Number(v)));
        if (looksLikeHeader){ fileCols = headerRow.map((c,i)=>(c==null||c==="")?`Cột ${i+1}`:String(c)); fileRows = fileRows.slice(1); }
        else { fileCols = headerRow.map((_,i)=>`Cột ${i+1}`); }
        // 20.4.2 Tự động ánh xạ + Cho phép sửa bằng select
        mapped = autoMapColumns(fileCols);
        populateMappingSelects(fileCols);
        renderPreview(fileRows, fileCols);

        setStatus($("fileInfo"), `Đã nhận được <b>${fileRows.length}</b> dòng`, "ok");
        $("btnPredictFile").disabled = fileRows.length === 0;
      }catch(err){
        setStatus($("fileInfo"), `Không đọc được file: ${err.message}`, "err");
      }
    }
    function parseCSV(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file, {
          complete: (res)=>{ if(res?.data?.length){ fileRows = res.data.filter(r=>r && r.length); resolve(); } else reject(new Error("CSV trống")); },
          error: reject, skipEmptyLines: true
        });
      });
    }
    function parseXLSX(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, {type:"array"});
          const ws = wb.Sheets[wb.SheetNames[0]];
          const arr = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:""});
          if(arr && arr.length){ fileRows = arr; resolve(); } else reject(new Error("Sheet trống"));
        };
        reader.onerror = ()=>reject(new Error("Đọc XLSX thất bại"));
        reader.readAsArrayBuffer(file);
      });
    }

    // Bước 21 — Dự đoán cho toàn bộ file + tiến độ + kết quả + xuất CSV
// Tóm tắt: Làm sạch dữ liệu → gọi API song song (tối đa 5 worker) → cập nhật % → bảng → CSV tải xuống.
    let fileCSV = "";
    $("btnPredictFile").addEventListener("click", async ()=>{
      if(!fileRows.length) return;
      show($("fileProgress"), true);
      $("progressBar").style.width = "0%"; $("progressText").textContent = "0%";
      setStatus($("fileStatus"), "Đang dự đoán…", "warn");
      $("btnPredictFile").disabled = true; $("btnDownloadFile").disabled = true;

      // 21.1 Làm sạch & kiểm tra dữ liệu theo ánh xạ cột
      const clean = [], errors = [];
      for(let i=0;i<fileRows.length;i++){
        const row = fileRows[i];
        const vals = [row[mapped.age], row[mapped.debt], row[mapped.avg], row[mapped.score]];
        const nums = vals.map(toNumber);
        if(nums.some(v=>Number.isNaN(v))){ errors.push(`Dòng ${i+1}: cột ánh xạ có giá trị không phải số.`); continue; }
        clean.push({idx:i+1, arr:nums});
      }
      if(errors.length){
        setStatus($("fileStatus"), `<b>Lỗi định dạng:</b><br>${errors.map(e=>"- "+e).join("<br>")}`, "err");
        $("btnPredictFile").disabled = false; return;
      }

      // 21.2 Chạy song song tối đa 5 worker để gọi API nhanh hơn + cập nhật % tiến độ
      const results = new Array(clean.length);
      const limit = 5; let done = 0;
      async function worker(start){
        for(let i=start;i<clean.length;i+=limit){
          const [ageVal,debt,avg,score] = clean[i].arr;
          const payloadObj = { age: ageVal, total_debt: debt, avg_amount: avg, credit_score: score };
          const payloadList = buildApiList(ageVal, debt, avg, score);
          const r = await callPredictionAPISmart(payloadObj, payloadList);
          results[i] = r.ok ? {msg:r.msg,name:r.name,hint:r.hint} : {msg:`Lỗi: ${r.msg}`,name:"",hint:""};
          done++; const pct = Math.round(done*100/clean.length);
          $("progressBar").style.width = pct+"%"; $("progressText").textContent = pct+"%";
        }
      }
      const workers = []; for(let w=0;w<Math.min(limit,clean.length);w++) workers.push(worker(w));
      await Promise.all(workers);

      // 21.3 Hiển thị bảng kết quả (giới hạn 1000 dòng để trình duyệt mượt)
      setStatus($("fileStatus"), `✅ Hoàn tất dự đoán ${clean.length} dòng.`, "ok");
      $("btnPredictFile").disabled = false; $("btnDownloadFile").disabled = false;

      const tbl=document.createElement("table");
      tbl.innerHTML=`<thead><tr>
        <th>#</th><th>age</th><th>total_debt</th><th>avg_amount</th><th>credit_score</th>
        <th>Kết quả</th><th>Tên cụm mô tả</th><th>Gợi ý hành động</th>
      </tr></thead><tbody></tbody>`;
      const tbody=tbl.querySelector("tbody");
      clean.slice(0,1000).forEach((r,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.idx}</td><td>${r.arr[0]}</td><td>${r.arr[1]}</td><td>${r.arr[2]}</td><td>${r.arr[3]}</td>
                      <td>${results[i].msg}</td><td>${results[i].name}</td><td>${results[i].hint}</td>`;
        tbody.appendChild(tr);
      });
      $("tableWrapFile").innerHTML=""; $("tableWrapFile").appendChild(tbl);

      // 21.4 Tạo CSV kết quả để tải xuống
      const header=["age","total_debt","avg_amount","credit_score","prediction","cluster_name","action_hint"];
      const rows = clean.map((r,i)=>[r.arr[0],r.arr[1],r.arr[2],r.arr[3],results[i].msg,results[i].name,results[i].hint]);
      fileCSV = [header.join(",")].concat(rows.map(r=>r.map(csvEscape).join(","))).join("\n");
    });

    // 21.5 Nút tải CSV cho luồng "tải file"
    $("btnDownloadFile").addEventListener("click", ()=>{
      if(!fileCSV) return;
      const blob = new Blob([withBOM(fileCSV)], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="ket_qua_du_doan.csv";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>
